---
title: "DE with spline model"
output: html_notebook
---

## Load the data

```{r}
library(edgeR)
library(ggplot2)
library(splines)
```

```{r}
expression <- read.csv('results/expression.csv', header=TRUE, row.names=1)
head(expression)
```

```{r}
annotation <- read.csv("results/annotation.csv", header=TRUE, row.names=1)
head(annotation)
```

## Filter low expressed genes

```{r}
y <- DGEList(counts=expression, samples=annotation)
y
```

```{r}
keep.genes <- filterByExpr(y, group=y$samples$condition, min.count=0.1, min.total.count=1)
table(keep.genes)
```

## Human vs Chimp

### Prepare the data

Let's filter macaque samples in expression and annotation dataframes

```{r}
comparison_ann <- annotation[(annotation$condition == 'human') | (annotation$condition == 'chimp'),]
head(comparison_ann)
```

```{r}
comparison_expr <- expression[, row.names(comparison_ann)]
head(comparison_expr)
```

Factor the data

```{r}
comparison_ann$layer <- factor(comparison_ann$layer)
comparison_ann$sample_id <- factor(comparison_ann$sample_id)
comparison_ann$condition <- factor(comparison_ann$condition)
head(comparison_ann)
```

```{r}
y <- DGEList(counts=comparison_expr, samples=comparison_ann)
y
```

### Filtering and normalization

Let's check a summary table

```{r}
summary(comparison_ann)
```

Now filter out low-expressed genes

```{r}
y <- y[keep.genes, , keep=FALSE]
```

TMM normalization

```{r}
y <- normLibSizes(y)
head(y$samples, n=10L)
```

```{r}
summary(y$samples$norm.factors)
```

### Data exploration

```{r}
layer <- as.factor(y$samples$layer)
condition <- y$samples$condition
plotMDS(y, pch=c(1:3)[condition], col=c(2:8)[layer])
legend("bottomright", legend=c(levels(layer), levels(condition)), pch=c(rep(16, 7), c(1:5)), col=c(c(2:8), rep(1, 3)), cex=0.8, ncol=2)
```

### Design matrix

```{r}
layer_c <- y$samples$layer_c
sample_id <- y$samples$sample_id
design <- model.matrix(~ sample_id + ns(layer_c, df=3) + condition:ns(layer_c, df=3))
colnames(design) <- gsub("condition", "", colnames(design))
colnames(design) <- gsub("sample_id", "", colnames(design))
colnames(design) <- gsub("ns\\(layer_c, df = 3)", "spline_", colnames(design))
head(design)
```

```{r}
colnames(design)
```

### Dispersion estimation

```{r}
y <- estimateDisp(y, design, robust=TRUE)
y$common.dispersion
```

```{r}
plotBCV(y)
```

```{r}
fit <- glmQLFit(y, design, robust=TRUE)
plotQLDisp(fit)
```

### DE genes identification

```{r}
qlf <- glmQLFTest(fit, coef=13:15)
```

```{r}
summary(decideTestsDGE(qlf))
```

```{r}
write.csv(qlf$table, file='results/edgeR_human_chimp.csv')
```

## Human vs Macaque

### Prepare the data

Let's filter macaque samples in expression and annotation dataframes

```{r}
comparison_ann <- annotation[(annotation$condition == 'human') | (annotation$condition == 'macaque'),]
head(comparison_ann)
```

```{r}
comparison_expr <- expression[, row.names(comparison_ann)]
head(comparison_expr)
```

Factor the data

```{r}
comparison_ann$layer <- factor(comparison_ann$layer)
comparison_ann$sample_id <- factor(comparison_ann$sample_id)
comparison_ann$condition <- factor(comparison_ann$condition)
head(comparison_ann)
```

```{r}
y <- DGEList(counts=comparison_expr, samples=comparison_ann)
y
```

### Filtering and normalization

Let's check a summary table

```{r}
summary(comparison_ann)
```

Now filter out low-expressed genes

```{r}
y <- y[keep.genes, , keep=FALSE]
```

TMM normalization

```{r}
y <- normLibSizes(y)
head(y$samples, n=10L)
```

```{r}
summary(y$samples$norm.factors)
```

### Data exploration

```{r}
layer <- as.factor(y$samples$layer)
condition <- y$samples$condition
plotMDS(y, pch=c(1:3)[condition], col=c(2:8)[layer])
legend("bottomright", legend=c(levels(layer), levels(condition)), pch=c(rep(16, 7), c(1:5)), col=c(c(2:8), rep(1, 3)), cex=0.8, ncol=2)
```

### Design matrix

```{r}
layer_c <- y$samples$layer_c
sample_id <- y$samples$sample_id
design <- model.matrix(~ sample_id + ns(layer_c, df=3) + condition:ns(layer_c, df=3))
colnames(design) <- gsub("condition", "", colnames(design))
colnames(design) <- gsub("sample_id", "", colnames(design))
colnames(design) <- gsub("ns\\(layer_c, df = 3)", "spline_", colnames(design))
head(design)
```

```{r}
colnames(design)
```

### Dispersion estimation

```{r}
y <- estimateDisp(y, design, robust=TRUE)
y$common.dispersion
```

```{r}
plotBCV(y)
```

```{r}
fit <- glmQLFit(y, design, robust=TRUE)
plotQLDisp(fit)
```

### DE genes identification

```{r}
qlf <- glmQLFTest(fit, coef=13:15)
```

```{r}
summary(decideTestsDGE(qlf))
```

```{r}
write.csv(qlf$table, file='results/edgeR_human_macaque.csv')
```

## Chimp vs Macaque

### Prepare the data

Let's filter macaque samples in expression and annotation dataframes

```{r}
comparison_ann <- annotation[(annotation$condition == 'macaque') | (annotation$condition == 'chimp'),]
head(comparison_ann)
```

```{r}
comparison_expr <- expression[, row.names(comparison_ann)]
head(comparison_expr)
```

Factor the data

```{r}
comparison_ann$layer <- factor(comparison_ann$layer)
comparison_ann$sample_id <- factor(comparison_ann$sample_id)
comparison_ann$condition <- factor(comparison_ann$condition)
head(comparison_ann)
```

```{r}
y <- DGEList(counts=comparison_expr, samples=comparison_ann)
y
```

### Filtering and normalization

Let's check a summary table

```{r}
summary(comparison_ann)
```

Now filter out low-expressed genes

```{r}
```

```{r}
y <- y[keep.genes, , keep=FALSE]
```

TMM normalization

```{r}
y <- normLibSizes(y)
head(y$samples, n=10L)
```

```{r}
summary(y$samples$norm.factors)
```

### Data exploration

```{r}
layer <- as.factor(y$samples$layer)
condition <- y$samples$condition
plotMDS(y, pch=c(1:3)[condition], col=c(2:8)[layer])
legend("bottomright", legend=c(levels(layer), levels(condition)), pch=c(rep(16, 7), c(1:5)), col=c(c(2:8), rep(1, 3)), cex=0.8, ncol=2)
```

### Design matrix

```{r}
layer_c <- y$samples$layer_c
sample_id <- y$samples$sample_id
design <- model.matrix(~ sample_id + ns(layer_c, df=3) + condition:ns(layer_c, df=3))
colnames(design) <- gsub("condition", "", colnames(design))
colnames(design) <- gsub("sample_id", "", colnames(design))
colnames(design) <- gsub("ns\\(layer_c, df = 3)", "spline_", colnames(design))
head(design)
```

```{r}
colnames(design)
```

### Dispersion estimation

```{r}
y <- estimateDisp(y, design, robust=TRUE)
y$common.dispersion
```

```{r}
plotBCV(y)
```

```{r}
fit <- glmQLFit(y, design, robust=TRUE)
plotQLDisp(fit)
```

### DE genes identification

```{r}
qlf <- glmQLFTest(fit, coef=12:14)
```

```{r}
summary(decideTestsDGE(qlf))
```

```{r}
write.csv(qlf$table, file='results/edgeR_chimp_macaque.csv')
```
