---
title: "DE with EdgeR"
output: html_notebook
---

```{r}
library(edgeR)
library(ggplot2)
```

```{r}
expression <- read.csv('results/expression.csv', header=TRUE, row.names=1)
head(expression)
```

```{r}
annotation <- read.csv("results/annotation.csv", header=TRUE, row.names=1)
head(annotation)
```

## Human markers

### Prepare the data

Let's filter human samples in expression and annotation dataframes

```{r}
human_ann <- annotation[annotation$condition == 'human',]
head(human_ann)
```

```{r}
human_expr <- expression[, row.names(human_ann)]
head(human_expr)

```

Factor the data

```{r}
human_ann$layer <- factor(human_ann$layer)
human_ann$sample_id <- factor(human_ann$sample_id)
head(human_ann)
```

```{r}
y <- DGEList(counts=human_expr, samples=human_ann)
y
```

### Filtering and normalization

Let's check a summary table

```{r}
summary(human_ann)
```

Now filter out low expressed genes

```{r}
keep.genes <- filterByExpr(y, group=y$samples$layer, min.count=0.01, min.total.count=1)
table(keep.genes)
```

```{r}
y <- y[keep.genes, , keep=FALSE]
```

TMM normalization

```{r}
y <- normLibSizes(y)
head(y$samples, n=10L)
```

```{r}
summary(y$samples$norm.factors)
```

### Data exploration

```{r}

```

```{r}
layer <- as.factor(y$samples$layer)
sample_id <- y$samples$sample_id
plotMDS(y, pch=c(1:5)[sample_id], col=c(2:8)[layer])
legend("bottomright", legend=c(levels(layer), levels(sample_id)), pch=c(rep(16, 7), c(1:5)), col=c(c(2:8), rep(1, 5)), cex=0.8, ncol=2)
```

### Design matrix

```{r}
design <- model.matrix(~ 0 + layer + sample_id)
colnames(design) <- gsub("sample_id", "", colnames(design))
colnames(design) <- gsub("layer", "", colnames(design))
head(design)
```

### Dispersion estimation

```{r}
y <- estimateDisp(y, design, robust=TRUE)
y$common.dispersion
```

```{r}
plotBCV(y)
```

```{r}
fit <- glmQLFit(y, design, robust=TRUE, legacy=FALSE)
plotQLDisp(fit)
```

### Marker genes identification

Make a contrast matrix

```{r}
ncls <- nlevels(layer)
contr <- rbind( matrix(1 / (1 - ncls), ncls, ncls),
                matrix(0, ncol(design) - ncls, ncls)
              )
diag(contr) <- 1
rownames(contr) <- colnames(design)
colnames(contr) <- levels(layer)
contr
```

Perform quasi-likelihood F-test

```{r}
qlf <- list()
for (i in 1:ncls){
  qlf[[i]] <- glmQLFTest(fit, contrast=contr[,i])
  qlf[[i]]$comparison <- paste0(levels(layer)[i], '_vs_others')
}
```

The top most significant DE genes for cluster L1

```{r}
topTags(qlf[[1]], n=10L)
```

```{r}
for (i in 1:ncls){
  write.csv(qlf[[i]]$table, file=paste0('results/humanDE/degenes_', levels(layer)[i], '.csv'))
}
```

The numbers of DE genes under each comparison

```{r}
dt <- lapply(lapply(qlf, decideTestsDGE), summary)
dt.all <- do.call("cbind", dt)
dt.all
```

Let's make a nice heatmap

```{r}
top <- 20
topMarkers <- list()
for (i in 1:ncls) {
  ord <- order(qlf[[i]]$table$PValue, decreasing=FALSE)
  up <- qlf[[i]]$table$logFC[ord] > 0
  topMarkers[[i]] <- rownames(y)[ord[up][1:top]]
}

topMarkers <- unique(unlist(topMarkers))
topMarkers
```

```{r}
lcpm <- cpm(y, log=TRUE)
annot <- data.frame(layer)
rownames(annot) <- colnames(y)
ann_colors <- list(layer=2:8)
names(ann_colors$layer) <- levels(layer)
pheatmap::pheatmap(lcpm[topMarkers,], breaks=seq(-2,2,length.out=101),
                   color=colorRampPalette(c("blue", "white", "red"))(100), scale="row",
                   ckuster_cols=TRUE, border_color="NA", fontsize_row=5,
                   treeheight_row=70, treeheight_col=70, cuttree_cols=7,
                   clustering_method="ward.D2", show_colnames=FALSE,
                   annotation_col=annot, annotation_colors=ann_colors)
```

## Chimp markers

### Prepare the data

Let's filter human samples in expression and annotation dataframes

```{r}
ann <- annotation[annotation$condition == 'chimp',]
head(ann)
```

```{r}
expr <- expression[, row.names(ann)]
head(expr)

```

Factor the data

```{r}
ann$layer <- factor(ann$layer)
ann$sample_id <- factor(ann$sample_id)
head(ann)
```

```{r}
y <- DGEList(counts=expr, samples=ann)
y
```

### Filtering and normalization

Let's check a summary table

```{r}
summary(ann)
```

Now filter out lowly expressed genes

```{r}
keep.genes <- filterByExpr(y, group=y$samples$layer, min.count=0.01, min.total.count=1)
table(keep.genes)
```

```{r}
y <- y[keep.genes, , keep=FALSE]
```

TMM normalization

```{r}
y <- normLibSizes(y)
head(y$samples, n=10L)
```

```{r}
summary(y$samples$norm.factors)
```

### Data exploration

```{r}

```

```{r}
layer <- as.factor(y$samples$layer)
sample_id <- y$samples$sample_id
plotMDS(y, pch=c(1:5)[sample_id], col=c(2:8)[layer])
legend("bottomright", legend=c(levels(layer), levels(sample_id)), pch=c(rep(16, 7), c(1:5)), col=c(c(2:8), rep(1, 5)), cex=0.8, ncol=2)
```

### Design matrix

```{r}
design <- model.matrix(~ 0 + layer + sample_id)
colnames(design) <- gsub("sample_id", "", colnames(design))
colnames(design) <- gsub("layer", "", colnames(design))
head(design)
```

### Dispersion estimation

```{r}
y <- estimateDisp(y, design, robust=TRUE)
y$common.dispersion
```

```{r}
plotBCV(y)
```

```{r}
fit <- glmQLFit(y, design, robust=TRUE, legacy=FALSE)
plotQLDisp(fit)
```

### Marker genes identification

Make a contrast matrix

```{r}
ncls <- nlevels(layer)
contr <- rbind( matrix(1 / (1 - ncls), ncls, ncls),
                matrix(0, ncol(design) - ncls, ncls)
              )
diag(contr) <- 1
rownames(contr) <- colnames(design)
colnames(contr) <- levels(layer)
contr
```

Perform quasi-likelihood F-test

```{r}
qlf <- list()
for (i in 1:ncls){
  qlf[[i]] <- glmQLFTest(fit, contrast=contr[,i])
  qlf[[i]]$comparison <- paste0(levels(layer)[i], '_vs_others')
}
```

The top most significant DE genes for cluster L1

```{r}
topTags(qlf[[1]], n=10L)
```

```{r}
for (i in 1:ncls){
  write.csv(qlf[[i]]$table, file=paste0('results/chimpDE/degenes_', levels(layer)[i], '.csv'))
}
```

The numbers of DE genes under each comparison

```{r}
dt <- lapply(lapply(qlf, decideTestsDGE), summary)
dt.all <- do.call("cbind", dt)
dt.all
```

Let's make a nice heatmap

```{r}
top <- 20
topMarkers <- list()
for (i in 1:ncls) {
  ord <- order(qlf[[i]]$table$PValue, decreasing=FALSE)
  up <- qlf[[i]]$table$logFC[ord] > 0
  topMarkers[[i]] <- rownames(y)[ord[up][1:top]]
}

topMarkers <- unique(unlist(topMarkers))
topMarkers
```

```{r}
lcpm <- cpm(y, log=TRUE)
annot <- data.frame(layer)
rownames(annot) <- colnames(y)
ann_colors <- list(layer=2:8)
names(ann_colors$layer) <- levels(layer)
pheatmap::pheatmap(lcpm[topMarkers,], breaks=seq(-2,2,length.out=101),
                   color=colorRampPalette(c("blue", "white", "red"))(100), scale="row",
                   ckuster_cols=TRUE, border_color="NA", fontsize_row=5,
                   treeheight_row=70, treeheight_col=70, cuttree_cols=7,
                   clustering_method="ward.D2", show_colnames=FALSE,
                   annotation_col=annot, annotation_colors=ann_colors)
```

## Macaque markers

### Prepare the data

Let's filter human samples in expression and annotation dataframes

```{r}
annotation
ann <- annotation[annotation$condition == 'macaque',]
head(ann)
```

```{r}
expr <- expression[, row.names(ann)]
head(expr)

```

Factor the data

```{r}
ann$layer <- factor(ann$layer)
ann$sample_id <- factor(ann$sample_id)
head(ann)
```

```{r}
y <- DGEList(counts=expr, samples=ann)
y
```

### Filtering and normalization

Let's check a summary table

```{r}
summary(ann)
```

Now filter out lowly expressed genes

```{r}
keep.genes <- filterByExpr(y, group=y$samples$layer, min.count=0.01, min.total.count=1)
table(keep.genes)
```

```{r}
y <- y[keep.genes, , keep=FALSE]
```

TMM normalization

```{r}
y <- normLibSizes(y)
head(y$samples, n=10L)
```

```{r}
summary(y$samples$norm.factors)
```

### Data exploration

```{r}

```

```{r}
layer <- as.factor(y$samples$layer)
sample_id <- y$samples$sample_id
plotMDS(y, pch=c(1:5)[sample_id], col=c(2:8)[layer])
legend("bottomright", legend=c(levels(layer), levels(sample_id)), pch=c(rep(16, 7), c(1:5)), col=c(c(2:8), rep(1, 5)), cex=0.8, ncol=2)
```

### Design matrix

```{r}
design <- model.matrix(~ 0 + layer + sample_id)
colnames(design) <- gsub("sample_id", "", colnames(design))
colnames(design) <- gsub("layer", "", colnames(design))
head(design)
```

### Dispersion estimation

```{r}
y <- estimateDisp(y, design, robust=TRUE)
y$common.dispersion
```

```{r}
plotBCV(y)
```

```{r}
fit <- glmQLFit(y, design, robust=TRUE, legacy=FALSE)
plotQLDisp(fit)
```

### Marker genes identification

Make a contrast matrix

```{r}
ncls <- nlevels(layer)
contr <- rbind( matrix(1 / (1 - ncls), ncls, ncls),
                matrix(0, ncol(design) - ncls, ncls)
              )
diag(contr) <- 1
rownames(contr) <- colnames(design)
colnames(contr) <- levels(layer)
contr
```

Perform quasi-likelihood F-test

```{r}
qlf <- list()
for (i in 1:ncls){
  qlf[[i]] <- glmQLFTest(fit, contrast=contr[,i])
  qlf[[i]]$comparison <- paste0(levels(layer)[i], '_vs_others')
}
```

The top most significant DE genes for cluster L1

```{r}
topTags(qlf[[1]], n=10L)
```

```{r}
for (i in 1:ncls){
  write.csv(qlf[[i]]$table, file=paste0('results/macaqueDE/degenes_', levels(layer)[i], '.csv'))
}
```

The numbers of DE genes under each comparison

```{r}
dt <- lapply(lapply(qlf, decideTestsDGE), summary)
dt.all <- do.call("cbind", dt)
dt.all
```

Let's make a nice heatmap

```{r}
top <- 20
topMarkers <- list()
for (i in 1:ncls) {
  ord <- order(qlf[[i]]$table$PValue, decreasing=FALSE)
  up <- qlf[[i]]$table$logFC[ord] > 0
  topMarkers[[i]] <- rownames(y)[ord[up][1:top]]
}

topMarkers <- unique(unlist(topMarkers))
topMarkers
```

```{r}
lcpm <- cpm(y, log=TRUE)
annot <- data.frame(layer)
rownames(annot) <- colnames(y)
ann_colors <- list(layer=2:8)
names(ann_colors$layer) <- levels(layer)
pheatmap::pheatmap(lcpm[topMarkers,], breaks=seq(-2,2,length.out=101),
                   color=colorRampPalette(c("blue", "white", "red"))(100), scale="row",
                   ckuster_cols=TRUE, border_color="NA", fontsize_row=5,
                   treeheight_row=70, treeheight_col=70, cuttree_cols=7,
                   clustering_method="ward.D2", show_colnames=FALSE,
                   annotation_col=annot, annotation_colors=ann_colors)
```

## Adult Human markers

```{r}
expression <- read.csv('results/expression_adult.csv', header=TRUE, row.names=1)
head(expression)
```

```{r}
annotation <- read.csv("results/annotation_adult.csv", header=TRUE, row.names=1)
head(annotation)
```

### Prepare the data

Let's filter human samples in expression and annotation dataframes

```{r}
human_ann <- annotation[annotation$condition == 'spatial_libd_human',]
head(human_ann)
```

```{r}
human_expr <- expression[, paste0("X", row.names(human_ann))]
head(human_expr)

```

Factor the data

```{r}
human_ann$layer <- factor(human_ann$layer)
human_ann$sample_id <- factor(human_ann$sample_id)
head(human_ann)
```

```{r}
y <- DGEList(counts=human_expr, samples=human_ann)
y
```

### Filtering and normalization

Let's check a summary table

```{r}
summary(human_ann)
```

Now filter out low expressed genes

```{r}
keep.genes <- filterByExpr(y, group=y$samples$layer, min.count=0.01, min.total.count=1)
table(keep.genes)
```

```{r}
y <- y[keep.genes, , keep=FALSE]
```

TMM normalization

```{r}
y <- normLibSizes(y)
head(y$samples, n=10L)
```

```{r}
summary(y$samples$norm.factors)
```

### Data exploration

```{r}
layer <- as.factor(y$samples$layer)
sample_id <- y$samples$sample_id
plotMDS(y, pch=c(1:5)[sample_id], col=c(2:8)[layer])
legend("bottomright", legend=c(levels(layer), levels(sample_id)), pch=c(rep(16, 7), c(1:5)), col=c(c(2:8), rep(1, 5)), cex=0.8, ncol=2)
```

### Design matrix

```{r}
design <- model.matrix(~ 0 + layer + sample_id)
colnames(design) <- gsub("sample_id", "", colnames(design))
colnames(design) <- gsub("layer", "", colnames(design))
head(design)
```

### Dispersion estimation

```{r}
y <- estimateDisp(y, design, robust=TRUE)
y$common.dispersion
```

```{r}
plotBCV(y)
```

```{r}
fit <- glmQLFit(y, design, robust=TRUE, legacy=FALSE)
plotQLDisp(fit)
```

### Marker genes identification

Make a contrast matrix

```{r}
ncls <- nlevels(layer)
contr <- rbind( matrix(1 / (1 - ncls), ncls, ncls),
                matrix(0, ncol(design) - ncls, ncls)
              )
diag(contr) <- 1
rownames(contr) <- colnames(design)
colnames(contr) <- levels(layer)
contr
```

Perform quasi-likelihood F-test

```{r}
qlf <- list()
for (i in 1:ncls){
  qlf[[i]] <- glmQLFTest(fit, contrast=contr[,i])
  qlf[[i]]$comparison <- paste0(levels(layer)[i], '_vs_others')
}
```

The top most significant DE genes for cluster L1

```{r}
topTags(qlf[[1]], n=10L)
```

```{r}
for (i in 1:ncls){
  write.csv(qlf[[i]]$table, file=paste0('results/adultsDE/degenes_', levels(layer)[i], '.csv'))
}
```

The numbers of DE genes under each comparison

```{r}
dt <- lapply(lapply(qlf, decideTestsDGE), summary)
dt.all <- do.call("cbind", dt)
dt.all
```

Let's make a nice heatmap

```{r}
top <- 20
topMarkers <- list()
for (i in 1:ncls) {
  ord <- order(qlf[[i]]$table$PValue, decreasing=FALSE)
  up <- qlf[[i]]$table$logFC[ord] > 0
  topMarkers[[i]] <- rownames(y)[ord[up][1:top]]
}

topMarkers <- unique(unlist(topMarkers))
topMarkers
```

```{r}
lcpm <- cpm(y, log=TRUE)
annot <- data.frame(layer)
rownames(annot) <- colnames(y)
ann_colors <- list(layer=2:8)
names(ann_colors$layer) <- levels(layer)
pheatmap::pheatmap(lcpm[topMarkers,], breaks=seq(-2,2,length.out=101),
                   color=colorRampPalette(c("blue", "white", "red"))(100), scale="row",
                   ckuster_cols=TRUE, border_color="NA", fontsize_row=5,
                   treeheight_row=70, treeheight_col=70, cuttree_cols=7,
                   clustering_method="ward.D2", show_colnames=FALSE,
                   annotation_col=annot, annotation_colors=ann_colors)
```

```{r}
sessionInfo()
```
